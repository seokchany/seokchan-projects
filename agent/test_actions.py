# μ΄ νμΌμ€ λ¨λ“  μ‹¤μ‹κ°„ λ€μ‘ κΈ°λ¥(λ°©ν™”λ²½, EDR, μ•λ¦Ό)μ„ ν• λ²μ— ν…μ¤νΈν•κΈ° μ„ν• μ¤ν¬λ¦½νΈμ…λ‹λ‹¤.

import time
import sys
import os

# --- ν…μ¤νΈ ν™κ²½ μ„¤μ • ---
# μ΄ μ¤ν¬λ¦½νΈκ°€ λ‹¤λ¥Έ ν΄λ”(installers, actions)μ λ¨λ“μ„ μ°Ύμ„ μ μλ„λ΅ κ²½λ΅λ¥Ό μ„¤μ •ν•©λ‹λ‹¤.
try:
    # `remediation.py`λ” κ°™μ€ ν΄λ”μ— μμΌλ―€λ΅ λ°”λ΅ μ„ν¬νΈν•©λ‹λ‹¤.
    from remediation import (
        handle_block_ip, handle_unblock_ip,
        handle_block_port, handle_unblock_port,
        handle_quarantine_host, handle_release_isolation
    )
except ImportError as e:
    print(f"\n[μ¤λ¥] ν•„μ λ¨λ“μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤: {e}")
    print("μ΄ μ¤ν¬λ¦½νΈλ” λ°λ“μ‹ 'agent' ν΄λ” μ•μ—μ„ μ‹¤ν–‰ν•΄μ•Ό ν•©λ‹λ‹¤.")
    sys.exit(1)


def run_full_test():
    """
    λ¨λ“  λ€μ‘ μ΅°μΉμ™€ μ•λ¦Ό κΈ°λ¥μ„ μμ„λ€λ΅ ν…μ¤νΈν•©λ‹λ‹¤.
    """
    print("π€ μ „μ²΄ λ€μ‘ κΈ°λ¥ ν…μ¤νΈλ¥Ό μ‹μ‘ν•©λ‹λ‹¤...")
    print("β οΈ  μ΄ ν…μ¤νΈλ” μ‹¤μ  λ°©ν™”λ²½ κ·μΉ™κ³Ό λ„¤νΈμ›ν¬ μ–΄λ‘ν„°λ¥Ό λ³€κ²½ν•©λ‹λ‹¤.")
    print("="*50)

    # --- ν…μ¤νΈμ— μ‚¬μ©ν•  λ³€μ ---
    test_ip = "8.8.8.8"  # κµ¬κΈ€ DNS IPλ΅ ν…μ¤νΈ
    test_port = 8888
    
    # --- 1. IP μ°¨λ‹¨/ν•΄μ  ν…μ¤νΈ ---
    print(f"\n[1/3] IP μ°¨λ‹¨/ν•΄μ  ν…μ¤νΈ (λ€μƒ IP: {test_ip})")
    print("-" * 40)
    
    print("1-1. IP μ°¨λ‹¨μ„ μ‹λ„ν•©λ‹λ‹¤...")
    print("   -> 'λ³΄μ• μ„ν‘ λ€μ‘ μ™„λ£' μ•λ¦Όμ΄ λ¨λ”μ§€ ν™•μΈν•μ„Έμ”.")
    handle_block_ip(test_ip)
    time.sleep(5) # μ‚¬μ©μκ°€ μ•λ¦Όμ„ ν™•μΈν•  μ‹κ°„μ„ μ¤λ‹λ‹¤.

    print("\n1-2. IP μ°¨λ‹¨ ν•΄μ λ¥Ό μ‹λ„ν•©λ‹λ‹¤...")
    print("   -> 'λ³΄μ• κ·μΉ™ μ—…λ°μ΄νΈ' μ•λ¦Όμ΄ λ¨λ”μ§€ ν™•μΈν•μ„Έμ”.")
    handle_unblock_ip(test_ip)
    time.sleep(5)

    # --- 2. ν¬νΈ μ°¨λ‹¨/ν•΄μ  ν…μ¤νΈ ---
    print(f"\n[2/3] ν¬νΈ μ°¨λ‹¨/ν•΄μ  ν…μ¤νΈ (λ€μƒ ν¬νΈ: {test_port})")
    print("-" * 40)
    
    print("2-1. ν¬νΈ μ°¨λ‹¨μ„ μ‹λ„ν•©λ‹λ‹¤...")
    print("   -> 'ν¬νΈ μ°¨λ‹¨ μ™„λ£' μ•λ¦Όμ΄ λ¨λ”μ§€ ν™•μΈν•μ„Έμ”.")
    handle_block_port(test_port)
    time.sleep(5)

    print("\n2-2. ν¬νΈ μ°¨λ‹¨ ν•΄μ λ¥Ό μ‹λ„ν•©λ‹λ‹¤...")
    print("   -> 'ν¬νΈ κ·μΉ™ μ—…λ°μ΄νΈ' μ•λ¦Όμ΄ λ¨λ”μ§€ ν™•μΈν•μ„Έμ”.")
    handle_unblock_port(test_port)
    time.sleep(5)
    
    # --- 3. νΈμ¤νΈ κ²©λ¦¬/ν•΄μ  ν…μ¤νΈ ---
    print("\n[3/3] νΈμ¤νΈ κ²©λ¦¬/ν•΄μ  ν…μ¤νΈ")
    print("β οΈ  κ²½κ³ : μ΄ ν…μ¤νΈλ” λ¨λ“  λ„¤νΈμ›ν¬ μ—°κ²°μ„ μ μ‹ λΉ„ν™μ„±ν™”ν–λ‹¤κ°€ λ‹¤μ‹ ν™μ„±ν™”ν•©λ‹λ‹¤.")
    print("-" * 40)
    
    # μ‚¬μ©μκ°€ μΈμ§€ν•κ³  μ§„ν–‰ν•  μ μλ„λ΅ ν™•μΈ κ³Όμ •μ„ μ¶”κ°€ν•©λ‹λ‹¤.
    input("μ¤€λΉ„λμ—μΌλ©΄ Enter ν‚¤λ¥Ό λλ¬ νΈμ¤νΈ κ²©λ¦¬ ν…μ¤νΈλ¥Ό κ³„μ†ν•μ„Έμ”...")

    print("\n3-1. νΈμ¤νΈ κ²©λ¦¬λ¥Ό μ‹λ„ν•©λ‹λ‹¤...")
    print("   -> 'λ„¤νΈμ›ν¬ κ²©λ¦¬ μ‹¤ν–‰' μ•λ¦Όμ΄ λ¨λ”μ§€ ν™•μΈν•μ„Έμ”.")
    handle_quarantine_host()
    print("   -> 10μ΄ ν›„ μλ™μΌλ΅ κ²©λ¦¬λ¥Ό ν•΄μ ν•©λ‹λ‹¤.")
    time.sleep(10)

    print("\n3-2. νΈμ¤νΈ κ²©λ¦¬ ν•΄μ λ¥Ό μ‹λ„ν•©λ‹λ‹¤...")
    print("   -> 'λ„¤νΈμ›ν¬ κ²©λ¦¬ ν•΄μ ' μ•λ¦Όμ΄ λ¨λ”μ§€ ν™•μΈν•μ„Έμ”.")
    handle_release_isolation()
    time.sleep(5)


    print("\n" + "="*50)
    print("β… λ¨λ“  ν…μ¤νΈκ°€ μ™„λ£λμ—μµλ‹λ‹¤.")


if __name__ == "__main__":
    # μ¤ν¬λ¦½νΈκ°€ κ΄€λ¦¬μ κ¶ν•μΌλ΅ μ‹¤ν–‰λμ—λ”μ§€ ν™•μΈν•©λ‹λ‹¤.
    try:
        import ctypes
        is_admin = (ctypes.windll.shell32.IsUserAnAdmin() != 0)
    except Exception:
        is_admin = False

    if not is_admin:
        print("\n[μ¤λ¥] μ΄ ν…μ¤νΈ μ¤ν¬λ¦½νΈλ” κ΄€λ¦¬μ κ¶ν•μΌλ΅ μ‹¤ν–‰ν•΄μ•Ό ν•©λ‹λ‹¤.")
        print("PowerShell λλ” cmdλ¥Ό 'κ΄€λ¦¬μ κ¶ν•μΌλ΅ μ‹¤ν–‰'ν• λ’¤ λ‹¤μ‹ μ‹λ„ν•΄μ£Όμ„Έμ”.")
    else:
        # winotify λΌμ΄λΈλ¬λ¦¬κ°€ μ„¤μΉλμ–΄ μλ”μ§€ ν™•μΈν•©λ‹λ‹¤.
        try:
            import winotify
        except ImportError:
            print("\n[μ¤λ¥] 'winotify' λΌμ΄λΈλ¬λ¦¬κ°€ μ„¤μΉλμ§€ μ•μ•μµλ‹λ‹¤.")
            print("ν…μ¤νΈλ¥Ό μ§„ν–‰ν•κΈ° μ „μ— ν„°λ―Έλ„μ— 'pip install winotify'λ¥Ό μ…λ ¥ν•μ—¬ μ„¤μΉν•΄μ£Όμ„Έμ”.")
        else:
            run_full_test()
